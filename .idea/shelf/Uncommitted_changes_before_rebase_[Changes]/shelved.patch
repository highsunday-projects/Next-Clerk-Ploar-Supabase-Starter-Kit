Index: .idea/workspace.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project version=\"4\">\n  <component name=\"AutoImportSettings\">\n    <option name=\"autoReloadType\" value=\"SELECTIVE\" />\n  </component>\n  <component name=\"ChangeListManager\">\n    <list default=\"true\" id=\"03e93c0d-3325-4b1e-b22c-75672eb5a3a6\" name=\"Changes\" comment=\"\">\n      <change beforePath=\"$PROJECT_DIR$/src/app/api/webhooks/polar/route.ts\" beforeDir=\"false\" afterPath=\"$PROJECT_DIR$/src/app/api/webhooks/polar/route.ts\" afterDir=\"false\" />\n    </list>\n    <option name=\"SHOW_DIALOG\" value=\"false\" />\n    <option name=\"HIGHLIGHT_CONFLICTS\" value=\"true\" />\n    <option name=\"HIGHLIGHT_NON_ACTIVE_CHANGELIST\" value=\"false\" />\n    <option name=\"LAST_RESOLUTION\" value=\"IGNORE\" />\n  </component>\n  <component name=\"Git.Settings\">\n    <option name=\"RECENT_BRANCH_BY_REPOSITORY\">\n      <map>\n        <entry key=\"$PROJECT_DIR$\" value=\"main\" />\n      </map>\n    </option>\n    <option name=\"RECENT_GIT_ROOT_PATH\" value=\"$PROJECT_DIR$\" />\n    <option name=\"RESET_MODE\" value=\"HARD\" />\n  </component>\n  <component name=\"GitRewordedCommitMessages\">\n    <option name=\"commitMessagesMapping\">\n      <RewordedCommitMessageMapping>\n        <option name=\"originalMessage\" value=\"adjust top\" />\n        <option name=\"rewordedMessage\" value=\"SF10 - 前端訂閱狀態顯示簡化 (簡化需求)\" />\n      </RewordedCommitMessageMapping>\n    </option>\n    <option name=\"currentCommit\" value=\"1\" />\n    <option name=\"onto\" value=\"99c9878a769ec6996fa4c0516d8deed67b53f9e9\" />\n  </component>\n  <component name=\"MarkdownSettingsMigration\">\n    <option name=\"stateVersion\" value=\"1\" />\n  </component>\n  <component name=\"ProjectId\" id=\"2zyx8YSFd5j4dGGD34zhTaIn90X\" />\n  <component name=\"ProjectViewState\">\n    <option name=\"hideEmptyMiddlePackages\" value=\"true\" />\n    <option name=\"showLibraryContents\" value=\"true\" />\n  </component>\n  <component name=\"PropertiesComponent\">{\n  &quot;keyToString&quot;: {\n    &quot;RunOnceActivity.OpenProjectViewOnStart&quot;: &quot;true&quot;,\n    &quot;RunOnceActivity.ShowReadmeOnStart&quot;: &quot;true&quot;,\n    &quot;WebServerToolWindowFactoryState&quot;: &quot;false&quot;,\n    &quot;last_opened_file_path&quot;: &quot;/Users/highsunday/Program/Next-Clerk-Ploar-Supabase Starter Kit/documents/功能&quot;,\n    &quot;node.js.detected.package.eslint&quot;: &quot;true&quot;,\n    &quot;node.js.detected.package.tslint&quot;: &quot;true&quot;,\n    &quot;node.js.selected.package.eslint&quot;: &quot;(autodetect)&quot;,\n    &quot;node.js.selected.package.tslint&quot;: &quot;(autodetect)&quot;,\n    &quot;nodejs_package_manager_path&quot;: &quot;npm&quot;,\n    &quot;ts.external.directory.path&quot;: &quot;/Applications/WebStorm.app/Contents/plugins/javascript-impl/jsLanguageServicesImpl/external&quot;,\n    &quot;vue.rearranger.settings.migration&quot;: &quot;true&quot;\n  }\n}</component>\n  <component name=\"RecentsManager\">\n    <key name=\"CopyFile.RECENT_KEYS\">\n      <recent name=\"$PROJECT_DIR$/documents/功能\" />\n    </key>\n  </component>\n  <component name=\"SpellCheckerSettings\" RuntimeDictionaries=\"0\" Folders=\"0\" CustomDictionaries=\"0\" DefaultDictionary=\"application-level\" UseSingleDictionary=\"true\" transferred=\"true\" />\n  <component name=\"TaskManager\">\n    <task active=\"true\" id=\"Default\" summary=\"Default task\">\n      <changelist id=\"03e93c0d-3325-4b1e-b22c-75672eb5a3a6\" name=\"Changes\" comment=\"\" />\n      <created>1752716954330</created>\n      <option name=\"number\" value=\"Default\" />\n      <option name=\"presentableId\" value=\"Default\" />\n      <updated>1752716954330</updated>\n      <workItem from=\"1752716957568\" duration=\"4429000\" />\n      <workItem from=\"1752921879652\" duration=\"10490000\" />\n      <workItem from=\"1753073750430\" duration=\"674000\" />\n    </task>\n    <servers />\n  </component>\n  <component name=\"TypeScriptGeneratedFilesManager\">\n    <option name=\"version\" value=\"3\" />\n  </component>\n  <component name=\"Vcs.Log.Tabs.Properties\">\n    <option name=\"TAB_STATES\">\n      <map>\n        <entry key=\"MAIN\">\n          <value>\n            <State />\n          </value>\n        </entry>\n      </map>\n    </option>\n  </component>\n</project>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/.idea/workspace.xml b/.idea/workspace.xml
--- a/.idea/workspace.xml	(revision 2ea00787e0fa981452fefc7654ef4af67c1b6586)
+++ b/.idea/workspace.xml	(date 1753081646783)
@@ -5,7 +5,7 @@
   </component>
   <component name="ChangeListManager">
     <list default="true" id="03e93c0d-3325-4b1e-b22c-75672eb5a3a6" name="Changes" comment="">
-      <change beforePath="$PROJECT_DIR$/src/app/api/webhooks/polar/route.ts" beforeDir="false" afterPath="$PROJECT_DIR$/src/app/api/webhooks/polar/route.ts" afterDir="false" />
+      <change beforePath="$PROJECT_DIR$/documents/功能/B01-Polar-Webhook-欄位映射錯誤修正.md" beforeDir="false" afterPath="$PROJECT_DIR$/documents/功能/B01-Polar-Webhook-欄位映射錯誤修正.md" afterDir="false" />
     </list>
     <option name="SHOW_DIALOG" value="false" />
     <option name="HIGHLIGHT_CONFLICTS" value="true" />
Index: documents/功能/B01-Polar-Webhook-欄位映射錯誤修正.md
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>---\nuuid: b01-polar-webhook-field-mapping-fix\n---\n\n# B01 - Polar Webhook 欄位映射錯誤修正\n\n## \uD83D\uDD0D 問題概述\n\n**問題描述**: 當用戶取消 Polar 訂閱時，webhook 觸發了多個事件，但 Supabase 狀態更新出現錯誤，最終狀態與預期不符。\n\n**影響範圍**: \n- 用戶取消訂閱後狀態顯示錯誤\n- 訂閱狀態在多個 webhook 事件間不一致\n- 關鍵資料（cancelAtPeriodEnd）遺失導致邏輯判斷失效\n\n**嚴重程度**: \uD83D\uDD34 高 - 影響付費用戶的訂閱狀態正確性\n\n## \uD83D\uDCCB 事件時序分析\n\n### 觸發的 Webhook 事件順序：\n1. **subscription.updated** - 設定取消標誌\n2. **subscription.canceled** - 訂閱取消事件  \n3. **subscription.updated** - 再次更新（重複事件）\n\n## ❌ 發現的主要問題\n\n### 1. **缺失數據問題**\n```javascript\nProcessing subscription update: {\n  subscriptionId: '1b7d5ed3-41eb-47d7-9184-ceae11a5fee5',\n  userId: 'user_3086xRRBAJLroUYxctPm1iG7kPC',\n  status: 'active',\n  cancelAtPeriodEnd: undefined,  // ❌ 關鍵資料遺失\n  currentPeriodStart: undefined, // ❌ 關鍵資料遺失\n  currentPeriodEnd: undefined    // ❌ 關鍵資料遺失\n}\n```\n\n**原因**: 程式碼從 webhook payload 提取資料時，欄位名稱不匹配\n\n### 2. **資料提取邏輯錯誤**\n在 `route.ts` 中的資料提取：\n```javascript\n// ❌ 錯誤的提取方式\ncancelAtPeriodEnd: subscription.cancel_at_period_end,\ncurrentPeriodStart: subscription.current_period_start,\ncurrentPeriodEnd: subscription.current_period_end\n```\n\n**實際 Payload 結構**:\n```javascript\n// ✅ 正確的欄位名稱 (camelCase)\n{\n  \"cancelAtPeriodEnd\": true,\n  \"currentPeriodStart\": \"2025-07-21T06:47:25.000Z\",\n  \"currentPeriodEnd\": \"2025-08-21T06:47:25.000Z\"\n}\n```\n\n### 3. **狀態判斷邏輯失效**\n因為 `cancelAtPeriodEnd` 為 `undefined`，`mapPolarStatusToLocal` 函數無法正確判斷：\n\n```javascript\n// ❌ 因為 cancelAtPeriodEnd = undefined，總是走 else 分支\nfunction mapPolarStatusToLocal(polarStatus: string, cancelAtPeriodEnd: boolean = false) {\n  switch (polarStatus) {\n    case 'active':\n      return cancelAtPeriodEnd ? 'active_ending' : 'active_recurring'; \n      // 結果總是 'active_recurring'，應該要是 'active_ending'\n  }\n}\n```\n\n### 4. **事件處理順序問題**\n- **subscription.updated** → 狀態變為 `active_recurring` ❌\n- **subscription.canceled** → 狀態變為 `active_ending` ✅  \n- **subscription.updated** → 又變回 `active_recurring` ❌\n\n最終結果錯誤！\n\n## \uD83D\uDD27 解決方案\n\n### 1. **修正資料提取邏輯**\n```javascript\n// ✅ 修正後的程式碼\nconsole.log('Processing subscription update:', {\n  subscriptionId: subscription.id,\n  userId: clerkUserId,\n  status: subscription.status,\n  cancelAtPeriodEnd: subscription.cancelAtPeriodEnd, // 修正欄位名稱\n  currentPeriodStart: subscription.currentPeriodStart, // 修正欄位名稱\n  currentPeriodEnd: subscription.currentPeriodEnd // 修正欄位名稱\n});\n```\n\n### 2. **改進狀態判斷邏輯**\n```javascript\n// ✅ 更安全的判斷方式\nfunction mapPolarStatusToLocal(subscription: any): SubscriptionStatus {\n  // 直接從完整的 subscription 物件判斷\n  const { status, cancelAtPeriodEnd, canceledAt } = subscription;\n  \n  if (status === 'active') {\n    // 檢查是否有取消標誌或取消時間\n    return (cancelAtPeriodEnd === true || canceledAt) ? 'active_ending' : 'active_recurring';\n  }\n  \n  return 'inactive';\n}\n```\n\n### 3. **事件去重機制**\n```javascript\n// ✅ 避免重複處理相同事件\nconst processedEvents = new Set();\n\nasync function handleSubscriptionUpdated(event: any): Promise<void> {\n  const eventKey = `${event.data.id}-${event.data.modified_at}`;\n  \n  if (processedEvents.has(eventKey)) {\n    console.log('Event already processed, skipping:', eventKey);\n    return;\n  }\n  \n  processedEvents.add(eventKey);\n  // ... 處理邏輯\n}\n```\n\n### 4. **優先處理取消事件**\n```javascript\n// ✅ 根據事件類型決定處理優先級\nasync function handleSubscriptionEvent(event: any): Promise<void> {\n  const subscription = event.data;\n  const clerkUserId = subscription.metadata?.clerk_user_id;\n  \n  // 如果有取消標誌，直接設定為 active_ending\n  if (subscription.cancelAtPeriodEnd === true || subscription.canceledAt) {\n    await updateSubscriptionStatus(clerkUserId, 'active_ending');\n    return;\n  }\n  \n  // 否則按一般邏輯處理\n  const status = mapPolarStatusToLocal(subscription);\n  await updateSubscriptionStatus(clerkUserId, status);\n}\n```\n\n## \uD83C\uDFAF 立即修正建議\n\n### 高優先級修正：\n1. ✅ **修正欄位名稱**: `cancel_at_period_end` → `cancelAtPeriodEnd`\n2. ✅ **修正函數調用**: 傳入完整 subscription 物件而非個別參數\n3. ✅ **加入事件去重**: 防止重複處理\n\n### 中優先級改進：\n1. \uD83D\uDD04 **加入詳細 logging**: 記錄每步驟的資料狀態\n2. \uD83D\uDD04 **錯誤恢復機制**: 當資料不一致時的修復邏輯\n3. \uD83D\uDD04 **監控告警**: 當狀態異常時發送通知\n\n## \uD83D\uDCA1 預防措施\n\n1. **型別檢查**: 使用 TypeScript 介面定義 webhook payload\n2. **單元測試**: 針對不同 webhook 事件組合進行測試  \n3. **整合測試**: 模擬完整的訂閱生命週期\n4. **監控儀表板**: 即時監控訂閱狀態變化\n\n## \uD83D\uDEA8 緊急修正步驟\n\n如果現在有用戶資料不正確：\n\n```sql\n-- 檢查問題用戶\nSELECT clerk_user_id, subscription_status, subscription_plan, current_period_end, polar_subscription_id\nFROM users \nWHERE polar_subscription_id = '1b7d5ed3-41eb-47d7-9184-ceae11a5fee5';\n\n-- 手動修正（確認 Polar 後台狀態後執行）\nUPDATE users \nSET subscription_status = 'active_ending'\nWHERE polar_subscription_id = '1b7d5ed3-41eb-47d7-9184-ceae11a5fee5'\nAND subscription_status = 'active_recurring';\n```\n\n## \uD83D\uDCDD 修正狀態\n\n- [x] 修正欄位名稱映射\n- [x] 更新狀態判斷邏輯\n- [x] 實作事件去重機制\n- [x] 加入詳細日誌記錄\n- [ ] 測試修正結果\n\n## \uD83D\uDD27 已完成的修正\n\n### 1. **欄位名稱映射修正** ✅\n- 修正 `subscription.cancel_at_period_end` → `subscription.cancelAtPeriodEnd`\n- 修正 `subscription.current_period_start` → `subscription.currentPeriodStart`\n- 修正 `subscription.current_period_end` → `subscription.currentPeriodEnd`\n\n### 2. **狀態判斷邏輯改進** ✅\n- 在 `mapPolarStatusToLocal` 函數中加入詳細日誌記錄\n- 在 `handleSubscriptionUpdated` 中加入智能狀態判斷：\n  - 優先檢查取消標誌 (`cancelAtPeriodEnd` 或 `canceledAt`)\n  - 有取消標誌的活躍訂閱直接設為 `active_ending`\n  - 避免狀態在多個事件間來回切換\n\n### 3. **事件去重機制** ✅\n- 實作 `processedEvents` Set 來追蹤已處理的事件\n- 使用 `eventKey` 格式：`{eventType}-{subscriptionId}-{modifiedAt}`\n- 在 `handleSubscriptionUpdated` 和 `handleSubscriptionCanceled` 中都加入去重檢查\n- 每小時自動清理過期的事件記錄\n\n### 4. **詳細日誌記錄** ✅\n- 在狀態映射函數中加入詳細的 console.log\n- 在事件處理函數中記錄處理邏輯的決策過程\n- 記錄事件去重的情況\n\n---\n\n**建立日期**: 2025-07-21  \n**負責人**: 開發團隊  \n**預計完成**: 2025-07-21  \n**優先級**: 高\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/documents/功能/B01-Polar-Webhook-欄位映射錯誤修正.md b/documents/功能/B01-Polar-Webhook-欄位映射錯誤修正.md
--- a/documents/功能/B01-Polar-Webhook-欄位映射錯誤修正.md	(revision 2ea00787e0fa981452fefc7654ef4af67c1b6586)
+++ b/documents/功能/B01-Polar-Webhook-欄位映射錯誤修正.md	(date 1753081536052)
@@ -215,6 +215,42 @@
 - 在事件處理函數中記錄處理邏輯的決策過程
 - 記錄事件去重的情況
 
+## 🧪 測試建議
+
+### 測試場景 1: 用戶取消訂閱
+1. 在 Polar 後台取消一個活躍訂閱
+2. 觀察 webhook 日誌，應該看到：
+   ```
+   Processing subscription update: {
+     subscriptionId: "xxx",
+     cancelAtPeriodEnd: true,  // ✅ 不再是 undefined
+     currentPeriodEnd: "2025-08-21T06:47:25.000Z"  // ✅ 不再是 undefined
+   }
+   Subscription marked for cancellation for user xxx - set to active_ending
+   ```
+3. 檢查資料庫，用戶狀態應為 `active_ending`
+
+### 測試場景 2: 重複事件處理
+1. 手動觸發相同的 webhook 事件
+2. 第二次應該看到：
+   ```
+   Event already processed, skipping: updated-xxx-timestamp
+   ```
+
+### 測試場景 3: 狀態映射
+1. 測試不同的 Polar 狀態值
+2. 檢查 `mapPolarStatusToLocal` 的日誌輸出：
+   ```
+   Mapping Polar status: { polarStatus: "active", cancelAtPeriodEnd: true }
+   Active status mapped to: active_ending
+   ```
+
+### 驗證清單
+- [ ] 取消訂閱後狀態正確顯示為 `active_ending`
+- [ ] 重複事件被正確過濾
+- [ ] 日誌記錄完整且清晰
+- [ ] 資料庫狀態與 Polar 後台一致
+
 ---
 
 **建立日期**: 2025-07-21  
