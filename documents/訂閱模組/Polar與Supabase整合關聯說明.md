---
uuid: a8f9e2d1c3b4567890abcdef12345678
---
# Polar èˆ‡ Supabase æ•´åˆé—œè¯èªªæ˜

## ğŸ“‹ æ–‡ä»¶æ¦‚è¿°

æœ¬æ–‡ä»¶è©³ç´°èªªæ˜ Next-Clerk-Polar-Supabase Starter Kit ä¸­ Polar ä»˜è²»ç³»çµ±èˆ‡ Supabase è³‡æ–™åº«ä¹‹é–“çš„æ•´åˆé—œè¯ï¼ŒåŒ…å«ç”¨æˆ¶è¨‚é–±ã€å–æ¶ˆè¨‚é–±ç­‰æ“ä½œçš„å®Œæ•´æµç¨‹ï¼Œä»¥åŠå„çµ„ä»¶ä¹‹é–“çš„é—œä¿‚èˆ‡é‚è¼¯ã€‚

### æ–‡ä»¶è³‡è¨Š
- **å»ºç«‹æ—¥æœŸ**: 2025-07-20
- **ç‰ˆæœ¬**: 1.0
- **ç›®æ¨™è®€è€…**: æ–°é€²å·¥ç¨‹å¸«ã€ç³»çµ±ç¶­è­·äººå“¡
- **ç¶­è­·è€…**: é–‹ç™¼åœ˜éšŠ

## ğŸ¯ æ•´åˆæ¦‚è¿°

### æ ¸å¿ƒæ¶æ§‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ (Next.js) â”‚    â”‚   Polar ä»˜è²»     â”‚    â”‚  Supabase è³‡æ–™åº« â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ è¨‚é–±ç®¡ç†é é¢   â”‚â—„â”€â”€â–ºâ”‚ â€¢ Checkout API  â”‚â—„â”€â”€â–ºâ”‚ â€¢ user_profiles â”‚
â”‚ â€¢ å‡ç´š/å–æ¶ˆæŒ‰éˆ•  â”‚    â”‚ â€¢ è¨‚é–±ç®¡ç†      â”‚    â”‚ â€¢ è¨‚é–±ç‹€æ…‹      â”‚
â”‚ â€¢ ç‹€æ…‹é¡¯ç¤º      â”‚    â”‚ â€¢ Webhook äº‹ä»¶  â”‚    â”‚ â€¢ ä½¿ç”¨é¡åº¦      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Clerk èªè­‰    â”‚    â”‚  API è·¯ç”±å±¤     â”‚    â”‚   Webhook è™•ç†   â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ ç”¨æˆ¶èº«ä»½é©—è­‰   â”‚    â”‚ â€¢ æ¬Šé™æª¢æŸ¥      â”‚    â”‚ â€¢ äº‹ä»¶æ¥æ”¶      â”‚
â”‚ â€¢ ç”¨æˆ¶ ID æä¾›  â”‚    â”‚ â€¢ è³‡æ–™é©—è­‰      â”‚    â”‚ â€¢ ç‹€æ…‹åŒæ­¥      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç°¡åŒ–çš„è¨‚é–±é‚è¼¯ (SF09)
- **è¨‚é–±æ–¹æ¡ˆ**: åƒ…æœ‰ã€Œå°ˆæ¥­ç‰ˆã€($5/æœˆ) ä¸€ç¨®ä»˜è²»æ–¹æ¡ˆ
- **ç”¨æˆ¶ç‹€æ…‹**: 
  - æœªè¨‚é–±: `subscription_plan = null`, `subscription_status = 'inactive'`
  - å·²è¨‚é–±: `subscription_plan = 'pro'`, `subscription_status = 'active'`
- **æ¬Šé™æ§åˆ¶**: é€šé `hasProAccess()` å‡½æ•¸çµ±ä¸€æª¢æŸ¥

## ğŸ—„ï¸ è³‡æ–™åº«çµæ§‹

### user_profiles è¡¨æ ¼
```sql
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clerk_user_id VARCHAR(255) UNIQUE NOT NULL,
  
  -- è¨‚é–±æ ¸å¿ƒæ¬„ä½
  subscription_plan VARCHAR(20),                    -- 'pro' æˆ– null
  subscription_status VARCHAR(20) DEFAULT 'inactive', -- 'active', 'inactive', 'past_due', 'cancelled'
  monthly_usage_limit INTEGER DEFAULT 1000,
  
  -- Polar æ•´åˆæ¬„ä½
  polar_customer_id VARCHAR(255),                   -- Polar å®¢æˆ¶ ID
  polar_subscription_id VARCHAR(255),               -- Polar è¨‚é–± ID
  current_period_end TIMESTAMP WITH TIME ZONE,      -- è¨ˆè²»é€±æœŸçµæŸæ™‚é–“
  cancel_at_period_end BOOLEAN DEFAULT FALSE,       -- æ˜¯å¦åœ¨é€±æœŸçµæŸæ™‚å–æ¶ˆ
  
  -- æ™‚é–“æˆ³è¨˜
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### é—œéµæ¬„ä½èªªæ˜
- **subscription_plan**: 'pro' è¡¨ç¤ºå°ˆæ¥­ç‰ˆï¼Œnull è¡¨ç¤ºæœªè¨‚é–±
- **subscription_status**: è¨‚é–±ç‹€æ…‹ï¼Œæ§åˆ¶å¯¦éš›æ¬Šé™
- **polar_customer_id**: é€£çµ Polar ç³»çµ±çš„å®¢æˆ¶è­˜åˆ¥ç¢¼
- **polar_subscription_id**: é€£çµ Polar ç³»çµ±çš„è¨‚é–±è­˜åˆ¥ç¢¼
- **current_period_end**: ç”¨æ–¼è¨ˆç®—è¨‚é–±åˆ°æœŸæ™‚é–“
- **cancel_at_period_end**: æ¨™è¨˜æ˜¯å¦å®‰æ’å–æ¶ˆè¨‚é–±

## ğŸ”„ ç”¨æˆ¶è¨‚é–±æµç¨‹

### 1. ç”¨æˆ¶å‡ç´šæµç¨‹

#### æ­¥é©Ÿ 1: å‰ç«¯è§¸ç™¼å‡ç´š
```typescript
// src/app/dashboard/subscription/page.tsx
const handlePlanUpgrade = async () => {
  const response = await fetch('/api/polar/create-checkout', {
    method: 'POST',
    body: JSON.stringify({
      plan: 'pro',
      userId: user?.id,
      successUrl: `${window.location.origin}/dashboard/subscription?success=true`
    })
  });
  
  const { checkoutUrl } = await response.json();
  window.location.href = checkoutUrl; // è·³è½‰åˆ° Polar ä»˜è²»é é¢
};
```

#### æ­¥é©Ÿ 2: å¾Œç«¯å»ºç«‹ Checkout Session
```typescript
// src/app/api/polar/create-checkout/route.ts
export async function POST(request: Request) {
  // 1. é©—è­‰ç”¨æˆ¶èº«ä»½ (Clerk)
  const { userId } = await auth();
  
  // 2. ç²å–ç”¨æˆ¶ç•¶å‰è¨‚é–±ç‹€æ…‹ (Supabase)
  const userProfile = await userProfileService.getOrCreateUserProfile(userId);
  
  // 3. å»ºç«‹ Polar Checkout Session
  const checkout = await polarApi.checkouts.create({
    products: [productId],
    successUrl: successUrl,
    customerEmail: userEmail,
    externalCustomerId: userId,
    metadata: {
      clerk_user_id: userId,
      subscription_plan: 'pro'
    }
  });
  
  return Response.json({ checkoutUrl: checkout.url });
}
```

#### æ­¥é©Ÿ 3: ç”¨æˆ¶å®Œæˆä»˜æ¬¾
- ç”¨æˆ¶åœ¨ Polar å®‰å…¨ç’°å¢ƒä¸­å®Œæˆä»˜æ¬¾
- Polar è™•ç†ä¿¡ç”¨å¡äº¤æ˜“
- å»ºç«‹è¨‚é–±è¨˜éŒ„

#### æ­¥é©Ÿ 4: Webhook äº‹ä»¶è™•ç†
```typescript
// src/app/api/webhooks/polar/route.ts
const webhookHandler = Webhooks({
  webhookSecret: process.env.POLAR_WEBHOOK_SECRET!,
  onSubscriptionCreated: async (payload) => {
    const subscription = payload.data;
    const clerkUserId = subscription.metadata?.clerk_user_id;
    
    // æ›´æ–° Supabase è³‡æ–™åº«
    await userProfileService.updateUserProfile(clerkUserId, {
      subscriptionPlan: 'pro',
      subscriptionStatus: 'active',
      monthlyUsageLimit: 10000,
      polarCustomerId: subscription.customer_id,
      polarSubscriptionId: subscription.id,
      currentPeriodEnd: subscription.current_period_end
    });
  }
});
```

#### æ­¥é©Ÿ 5: å‰ç«¯ç‹€æ…‹æ›´æ–°
- ç”¨æˆ¶è¢«é‡å®šå‘å›æ‡‰ç”¨ç¨‹å¼
- å‰ç«¯é‡æ–°è¼‰å…¥è¨‚é–±è³‡æ–™
- é¡¯ç¤ºæ–°çš„å°ˆæ¥­ç‰ˆç‹€æ…‹

### 2. ç”¨æˆ¶å–æ¶ˆè¨‚é–±æµç¨‹

#### æ­¥é©Ÿ 1: å‰ç«¯è§¸ç™¼å–æ¶ˆ
```typescript
// å®‰æ’åœ¨é€±æœŸçµæŸæ™‚å–æ¶ˆè¨‚é–±
const handleCancelSubscription = async () => {
  const response = await fetch('/api/polar/schedule-downgrade', {
    method: 'POST',
    body: JSON.stringify({
      targetPlan: 'free',
      userId: user?.id
    })
  });
};
```

#### æ­¥é©Ÿ 2: å¾Œç«¯è™•ç†å–æ¶ˆè«‹æ±‚
```typescript
// src/app/api/polar/schedule-downgrade/route.ts
export async function POST(request: Request) {
  // 1. é©—è­‰ç”¨æˆ¶èº«ä»½å’Œè¨‚é–±ç‹€æ…‹
  const userProfile = await userProfileService.getOrCreateUserProfile(userId);
  
  // 2. ä½¿ç”¨ Polar API è¨­å®šåœ¨é€±æœŸçµæŸæ™‚å–æ¶ˆ
  const updatedSubscription = await polarApi.subscriptions.update({
    id: userProfile.polar_subscription_id,
    subscriptionUpdate: {
      cancelAtPeriodEnd: true
    }
  });
  
  // 3. æ›´æ–°è³‡æ–™åº«æ¨™è¨˜
  await userProfileService.updateUserProfile(userId, {
    cancelAtPeriodEnd: true
  });
}
```

#### æ­¥é©Ÿ 3: é€±æœŸçµæŸæ™‚çš„è‡ªå‹•è™•ç†
- Polar åœ¨è¨ˆè²»é€±æœŸçµæŸæ™‚è§¸ç™¼ `subscription.canceled` äº‹ä»¶
- Webhook è™•ç†å™¨è‡ªå‹•å°‡ç”¨æˆ¶é™ç´šç‚ºæœªè¨‚é–±ç‹€æ…‹

```typescript
// Webhook è™•ç†å–æ¶ˆäº‹ä»¶
onSubscriptionCanceled: async (payload) => {
  const subscription = payload.data;
  const clerkUserId = subscription.metadata?.clerk_user_id;
  
  // å°‡ç”¨æˆ¶é™ç´šç‚ºæœªè¨‚é–±ç‹€æ…‹
  await userProfileService.updateUserProfile(clerkUserId, {
    subscriptionPlan: null,
    subscriptionStatus: 'inactive',
    monthlyUsageLimit: 1000,
    polarSubscriptionId: undefined,
    polarCustomerId: undefined,
    currentPeriodEnd: undefined,
    cancelAtPeriodEnd: false
  });
}
```

## ğŸ”§ æ ¸å¿ƒçµ„ä»¶é—œè¯

### 1. å‰ç«¯çµ„ä»¶

#### è¨‚é–±ç®¡ç†é é¢ (`src/app/dashboard/subscription/page.tsx`)
- **åŠŸèƒ½**: é¡¯ç¤ºç•¶å‰è¨‚é–±ç‹€æ…‹ï¼Œæä¾›å‡ç´š/å–æ¶ˆæŒ‰éˆ•
- **è³‡æ–™ä¾†æº**: é€šé `useUserProfile` Hook å¾ Supabase ç²å–
- **æ“ä½œ**: å‘¼å« Polar API é€²è¡Œè¨‚é–±è®Šæ›´

#### ç”¨æˆ¶è³‡æ–™ Hook (`src/hooks/useUserProfile.ts`)
- **åŠŸèƒ½**: ç®¡ç†ç”¨æˆ¶è¨‚é–±è³‡æ–™çš„å‰ç«¯ç‹€æ…‹
- **API å‘¼å«**: `/api/user/subscription` ç«¯é»
- **è‡ªå‹•æ›´æ–°**: ç›£è½è³‡æ–™è®ŠåŒ–ï¼Œè‡ªå‹•é‡æ–°è¼‰å…¥

### 2. å¾Œç«¯ API å±¤

#### ç”¨æˆ¶è¨‚é–± API (`src/app/api/user/subscription/route.ts`)
- **GET**: ç²å–ç•¶å‰ç”¨æˆ¶çš„è¨‚é–±è³‡æ–™
- **PATCH**: æ›´æ–°ç”¨æˆ¶è¨‚é–±è³‡æ–™
- **æ¬Šé™æ§åˆ¶**: ä½¿ç”¨ Clerk é©—è­‰ç”¨æˆ¶èº«ä»½

#### Polar Checkout API (`src/app/api/polar/create-checkout/route.ts`)
- **åŠŸèƒ½**: å»ºç«‹ Polar ä»˜è²» Session
- **æ™ºèƒ½æª¢æ¸¬**: å€åˆ†æ–°ç”¨æˆ¶å’Œç¾æœ‰è¨‚é–±ç”¨æˆ¶
- **å®‰å…¨æ€§**: ç¢ºä¿ç”¨æˆ¶åªèƒ½ç‚ºè‡ªå·±å»ºç«‹è¨‚é–±

#### Polar Webhook (`src/app/api/webhooks/polar/route.ts`)
- **åŠŸèƒ½**: æ¥æ”¶ Polar äº‹ä»¶ï¼ŒåŒæ­¥è¨‚é–±ç‹€æ…‹
- **äº‹ä»¶é¡å‹**: 
  - `subscription.created`: è¨‚é–±å»ºç«‹
  - `subscription.updated`: è¨‚é–±æ›´æ–°
  - `subscription.canceled`: è¨‚é–±å–æ¶ˆ
  - `order.paid`: ä»˜æ¬¾æˆåŠŸ

### 3. è³‡æ–™æœå‹™å±¤

#### ç”¨æˆ¶è³‡æ–™æœå‹™ (`src/lib/userProfileService.ts`)
- **getUserProfile()**: æ ¹æ“š Clerk ID ç²å–ç”¨æˆ¶è³‡æ–™
- **updateUserProfile()**: æ›´æ–°ç”¨æˆ¶è¨‚é–±è³‡æ–™
- **getOrCreateUserProfile()**: ç²å–æˆ–å»ºç«‹ç”¨æˆ¶è¨˜éŒ„
- **è³‡æ–™åº«æ“ä½œ**: ä½¿ç”¨ Supabase Admin å®¢æˆ¶ç«¯

#### Polar å®¢æˆ¶ç«¯ (`src/lib/polar.ts`)
- **polarApi**: Polar SDK å®¢æˆ¶ç«¯å¯¦ä¾‹
- **é…ç½®ç®¡ç†**: ç”¢å“ IDã€ç’°å¢ƒè¨­å®š
- **å·¥å…·å‡½æ•¸**: ç”¢å“æ˜ å°„ã€URL å»ºæ§‹

## ğŸ” å®‰å…¨æ©Ÿåˆ¶

### 1. èº«ä»½é©—è­‰æµç¨‹
```
ç”¨æˆ¶è«‹æ±‚ â†’ Clerk é©—è­‰ â†’ ç²å– userId â†’ è³‡æ–™åº«æŸ¥è©¢ â†’ æ¬Šé™æª¢æŸ¥
```

### 2. Webhook å®‰å…¨é©—è­‰
```typescript
// HMAC-SHA256 ç°½åé©—è­‰
export function verifyPolarWebhook(payload: string, signature: string): boolean {
  const expectedSignature = crypto
    .createHmac('sha256', WEBHOOK_SECRET)
    .update(payload, 'utf8')
    .digest('hex');
  
  return crypto.timingSafeEqual(
    Buffer.from(signature.replace(/^sha256=/, ''), 'hex'),
    Buffer.from(expectedSignature, 'hex')
  );
}
```

### 3. è³‡æ–™å­˜å–æ§åˆ¶
- **Row Level Security**: Supabase å•Ÿç”¨ RLS ç¢ºä¿ç”¨æˆ¶åªèƒ½å­˜å–è‡ªå·±çš„è³‡æ–™
- **API æ¬Šé™**: æ‰€æœ‰ API ç«¯é»éƒ½éœ€è¦ Clerk èªè­‰
- **Webhook é©—è­‰**: ä½¿ç”¨ HMAC ç°½åç¢ºä¿äº‹ä»¶ä¾†æºå¯ä¿¡

## ğŸ¯ æ¬Šé™æ§åˆ¶é‚è¼¯

### çµ±ä¸€æ¬Šé™æª¢æŸ¥å‡½æ•¸
```typescript
// src/lib/subscriptionUtils.ts
export function hasProAccess(profile: UserProfile | null): boolean {
  if (!profile) return false;
  
  return profile.subscription_plan === 'pro' && 
         profile.subscription_status === 'active';
}
```

### å‰ç«¯æ¬Šé™æ‡‰ç”¨
```typescript
// åœ¨çµ„ä»¶ä¸­ä½¿ç”¨
const { profile } = useUserProfile();
const canAccessProFeatures = hasProAccess(profile);

if (canAccessProFeatures) {
  // é¡¯ç¤ºå°ˆæ¥­ç‰ˆåŠŸèƒ½
} else {
  // é¡¯ç¤ºå‡ç´šæç¤º
}
```

## ğŸ“Š è³‡æ–™æµå‘åœ–

```
ç”¨æˆ¶æ“ä½œ â†’ å‰ç«¯çµ„ä»¶ â†’ API è·¯ç”± â†’ æœå‹™å±¤ â†’ Supabase
    â†“
Polar API â† Webhook â† Polar ç³»çµ± â† ä»˜æ¬¾è™•ç†
    â†“
è³‡æ–™åº«æ›´æ–° â†’ å‰ç«¯ç‹€æ…‹æ›´æ–° â†’ UI é‡æ–°æ¸²æŸ“
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ
1. **è¨‚é–±ç‹€æ…‹ä¸åŒæ­¥**: æª¢æŸ¥ Webhook äº‹ä»¶æ˜¯å¦æ­£ç¢ºè™•ç†
2. **ä»˜æ¬¾æˆåŠŸä½†ç‹€æ…‹æœªæ›´æ–°**: ç¢ºèª `clerk_user_id` åœ¨ metadata ä¸­æ­£ç¢ºå‚³é
3. **æ¬Šé™æª¢æŸ¥å¤±æ•—**: é©—è­‰ `hasProAccess()` å‡½æ•¸é‚è¼¯
4. **Webhook é©—è­‰å¤±æ•—**: æª¢æŸ¥ `POLAR_WEBHOOK_SECRET` ç’°å¢ƒè®Šæ•¸

### èª¿è©¦å·¥å…·
- Webhook äº‹ä»¶æ—¥èªŒè¨˜éŒ„
- è³‡æ–™åº«ç‹€æ…‹æŸ¥è©¢
- Polar Dashboard è¨‚é–±ç‹€æ…‹æª¢æŸ¥
- å‰ç«¯é–‹ç™¼è€…å·¥å…·ç¶²è·¯è«‹æ±‚ç›£æ§

## ğŸ’¡ å¯¦ä½œç´°ç¯€èˆ‡æœ€ä½³å¯¦è¸

### 1. éŒ¯èª¤è™•ç†ç­–ç•¥

#### API å±¤éŒ¯èª¤è™•ç†
```typescript
// çµ±ä¸€çš„éŒ¯èª¤å›æ‡‰æ ¼å¼
export interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
}

// éŒ¯èª¤è™•ç†ç¯„ä¾‹
try {
  const result = await userProfileService.updateUserProfile(userId, updateData);
  return Response.json({ success: true, data: result });
} catch (error) {
  console.error('API Error:', error);
  return Response.json({
    success: false,
    error: error.message || 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦'
  }, { status: 500 });
}
```

#### Webhook éŒ¯èª¤è™•ç†
```typescript
// Webhook äº‹ä»¶è™•ç†å¤±æ•—æ™‚çš„é‡è©¦æ©Ÿåˆ¶
async function handleSubscriptionCreated(event: any): Promise<void> {
  try {
    await userProfileService.updateUserProfile(clerkUserId, updateData);
    console.log(`âœ… Subscription created successfully for user ${clerkUserId}`);
  } catch (error) {
    console.error(`âŒ Failed to process subscription.created for user ${clerkUserId}:`, error);
    // Polar æœƒè‡ªå‹•é‡è©¦å¤±æ•—çš„ Webhook
    throw error;
  }
}
```

### 2. è³‡æ–™ä¸€è‡´æ€§ä¿è­‰

#### å†ªç­‰æ€§è™•ç†
```typescript
// ç¢ºä¿é‡è¤‡çš„ Webhook äº‹ä»¶ä¸æœƒé€ æˆè³‡æ–™ä¸ä¸€è‡´
async function handleSubscriptionCreated(event: any): Promise<void> {
  const subscription = event.data;
  const clerkUserId = subscription.metadata?.clerk_user_id;

  // æª¢æŸ¥æ˜¯å¦å·²ç¶“è™•ç†éæ­¤è¨‚é–±
  const existingProfile = await userProfileService.getUserProfile(clerkUserId);
  if (existingProfile?.polar_subscription_id === subscription.id) {
    console.log(`Subscription ${subscription.id} already processed, skipping`);
    return;
  }

  // ç¹¼çºŒè™•ç†...
}
```

#### äº¤æ˜“æ€§æ›´æ–°
```typescript
// ä½¿ç”¨ Supabase äº¤æ˜“ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§
async function updateUserSubscription(userId: string, subscriptionData: any) {
  const supabase = getSupabaseClient(true);

  const { data, error } = await supabase.rpc('update_user_subscription', {
    p_clerk_user_id: userId,
    p_subscription_plan: subscriptionData.subscriptionPlan,
    p_subscription_status: subscriptionData.subscriptionStatus,
    p_polar_subscription_id: subscriptionData.polarSubscriptionId
  });

  if (error) throw error;
  return data;
}
```

### 3. æ•ˆèƒ½å„ªåŒ–

#### å¿«å–ç­–ç•¥
```typescript
// ä½¿ç”¨ React Query å¿«å–ç”¨æˆ¶è¨‚é–±è³‡æ–™
export function useUserProfile() {
  const { user } = useUser();

  return useQuery({
    queryKey: ['userProfile', user?.id],
    queryFn: fetchUserProfile,
    staleTime: 5 * 60 * 1000, // 5 åˆ†é˜
    cacheTime: 10 * 60 * 1000, // 10 åˆ†é˜
    enabled: !!user?.id
  });
}
```

#### è³‡æ–™åº«ç´¢å¼•å„ªåŒ–
```sql
-- ç‚ºå¸¸ç”¨æŸ¥è©¢å»ºç«‹ç´¢å¼•
CREATE INDEX idx_user_profiles_clerk_user_id ON user_profiles(clerk_user_id);
CREATE INDEX idx_user_profiles_polar_subscription_id ON user_profiles(polar_subscription_id);
CREATE INDEX idx_user_profiles_subscription_status ON user_profiles(subscription_status);
```

### 4. ç›£æ§èˆ‡æ—¥èªŒ

#### çµæ§‹åŒ–æ—¥èªŒ
```typescript
// çµ±ä¸€çš„æ—¥èªŒæ ¼å¼
interface LogEvent {
  timestamp: string;
  level: 'info' | 'warn' | 'error';
  event: string;
  userId?: string;
  subscriptionId?: string;
  metadata?: Record<string, any>;
}

function logSubscriptionEvent(event: string, data: any) {
  const logEntry: LogEvent = {
    timestamp: new Date().toISOString(),
    level: 'info',
    event,
    userId: data.clerkUserId,
    subscriptionId: data.polarSubscriptionId,
    metadata: data
  };

  console.log(JSON.stringify(logEntry));
}
```

#### é—œéµæŒ‡æ¨™ç›£æ§
- Webhook äº‹ä»¶è™•ç†æˆåŠŸç‡
- è¨‚é–±è½‰æ›ç‡ (å…è²» â†’ å°ˆæ¥­ç‰ˆ)
- ä»˜æ¬¾æˆåŠŸç‡
- API å›æ‡‰æ™‚é–“
- è³‡æ–™åº«æŸ¥è©¢æ•ˆèƒ½

### 5. æ¸¬è©¦ç­–ç•¥

#### å–®å…ƒæ¸¬è©¦ç¯„ä¾‹
```typescript
// æ¸¬è©¦ç”¨æˆ¶è¨‚é–±æœå‹™
describe('UserProfileService', () => {
  it('should create user profile with default values', async () => {
    const mockUserId = 'user_123';
    const profile = await userProfileService.getOrCreateUserProfile(mockUserId);

    expect(profile.subscription_plan).toBeNull();
    expect(profile.subscription_status).toBe('inactive');
    expect(profile.monthly_usage_limit).toBe(1000);
  });

  it('should update subscription to pro plan', async () => {
    const mockUserId = 'user_123';
    const updateData = {
      subscriptionPlan: 'pro',
      subscriptionStatus: 'active',
      monthlyUsageLimit: 10000
    };

    const updatedProfile = await userProfileService.updateUserProfile(mockUserId, updateData);
    expect(updatedProfile.subscription_plan).toBe('pro');
  });
});
```

#### æ•´åˆæ¸¬è©¦
```typescript
// æ¸¬è©¦å®Œæ•´çš„è¨‚é–±æµç¨‹
describe('Subscription Flow Integration', () => {
  it('should handle complete subscription creation flow', async () => {
    // 1. æ¨¡æ“¬ç”¨æˆ¶å»ºç«‹ Checkout
    const checkoutResponse = await request(app)
      .post('/api/polar/create-checkout')
      .send({ plan: 'pro', userId: 'user_123' });

    // 2. æ¨¡æ“¬ Polar Webhook äº‹ä»¶
    const webhookPayload = {
      type: 'subscription.created',
      data: {
        id: 'sub_123',
        customer_id: 'cus_123',
        metadata: { clerk_user_id: 'user_123' }
      }
    };

    await request(app)
      .post('/api/webhooks/polar')
      .send(webhookPayload);

    // 3. é©—è­‰è³‡æ–™åº«ç‹€æ…‹
    const profile = await userProfileService.getUserProfile('user_123');
    expect(profile.subscription_plan).toBe('pro');
  });
});
```

## ğŸš€ éƒ¨ç½²èˆ‡ç¶­è­·

### ç’°å¢ƒè®Šæ•¸æª¢æŸ¥æ¸…å–®
```bash
# Clerk èªè­‰
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxx
CLERK_SECRET_KEY=sk_test_xxx
CLERK_WEBHOOK_SECRET=whsec_xxx

# Supabase è³‡æ–™åº«
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx
SUPABASE_SERVICE_ROLE_KEY=eyJxxx

# Polar ä»˜è²»
POLAR_ACCESS_TOKEN=polar_at_xxx
POLAR_WEBHOOK_SECRET=whsec_xxx
NEXT_PUBLIC_POLAR_ORGANIZATION_ID=org_xxx
POLAR_PRO_PRODUCT_ID=prod_xxx
NEXT_PUBLIC_POLAR_ENVIRONMENT=sandbox # æˆ– production

# æ‡‰ç”¨ç¨‹å¼
NEXT_PUBLIC_APP_URL=https://your-app.com
```

### å¥åº·æª¢æŸ¥ç«¯é»
```typescript
// src/app/api/health/route.ts
export async function GET() {
  const checks = {
    database: await checkSupabaseConnection(),
    polar: await checkPolarConnection(),
    timestamp: new Date().toISOString()
  };

  const isHealthy = Object.values(checks).every(check =>
    typeof check === 'boolean' ? check : true
  );

  return Response.json(checks, {
    status: isHealthy ? 200 : 503
  });
}
```

### è³‡æ–™å‚™ä»½ç­–ç•¥
- å®šæœŸå‚™ä»½ Supabase è³‡æ–™åº«
- ç›£æ§ Polar è¨‚é–±ç‹€æ…‹åŒæ­¥
- ä¿ç•™ Webhook äº‹ä»¶æ—¥èªŒ
- å®šæœŸé©—è­‰è³‡æ–™ä¸€è‡´æ€§

## ğŸ“š é–‹ç™¼è€…æŒ‡å—

### æ–°å¢åŠŸèƒ½æ™‚çš„æ³¨æ„äº‹é …
1. **ä¿æŒè³‡æ–™ä¸€è‡´æ€§**: ä»»ä½•è¨‚é–±ç›¸é—œè®Šæ›´éƒ½è¦åŒæ™‚æ›´æ–° Polar å’Œ Supabase
2. **æ¬Šé™æª¢æŸ¥**: ä½¿ç”¨ `hasProAccess()` çµ±ä¸€æª¢æŸ¥ç”¨æˆ¶æ¬Šé™
3. **éŒ¯èª¤è™•ç†**: æä¾›å‹å–„çš„ç”¨æˆ¶éŒ¯èª¤è¨Šæ¯
4. **æ—¥èªŒè¨˜éŒ„**: è¨˜éŒ„é—œéµæ“ä½œä¾¿æ–¼é™¤éŒ¯
5. **æ¸¬è©¦è¦†è“‹**: ç‚ºæ–°åŠŸèƒ½ç·¨å¯«é©ç•¶çš„æ¸¬è©¦

### å¸¸ç”¨é–‹ç™¼å‘½ä»¤
```bash
# å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ
npm run dev

# æª¢æŸ¥ç¨‹å¼ç¢¼å“è³ª
npm run lint

# åŸ·è¡Œæ¸¬è©¦
npm test

# å»ºç½®ç”Ÿç”¢ç‰ˆæœ¬
npm run build
```

---

**æ–‡æª”ç‰ˆæœ¬**: 1.0
**æœ€å¾Œæ›´æ–°**: 2025-07-20
**ç¶­è­·è€…**: é–‹ç™¼åœ˜éšŠ
**ç‹€æ…‹**: âœ… å·²å®Œæˆ
