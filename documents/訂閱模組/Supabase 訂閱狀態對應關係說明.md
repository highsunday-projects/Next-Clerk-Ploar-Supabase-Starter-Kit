# Supabase 訂閱狀態對應關係說明

## 📋 文件概述

本文件說明 Next-Clerk-Polar-Supabase Starter Kit 中，如何透過 Supabase 資料庫欄位來判斷用戶的三種訂閱狀態。適合新進工程師與 PM 快速理解系統邏輯。

### 文件資訊
- **建立日期**: 2025-07-20
- **版本**: 2.0 (簡化版)
- **目標讀者**: 新進工程師、產品經理、QA 測試人員
- **維護者**: 開發團隊

---

## 🎯 三種用戶訂閱狀態

### 1. 📈 訂閱中、會續訂
- **用戶狀態**: 已付費，訂閱會自動續費
- **權限**: 享有完整專業版功能
- **用戶體驗**: 無需任何操作，服務持續

### 2. ⏰ 訂閱中、時間到會到期  
- **用戶狀態**: 已付費，但用戶主動取消了續訂
- **權限**: 目前仍有專業版功能，到期後失效
- **用戶體驗**: 會看到到期提醒，可以重新啟用

### 3. 🆓 免費版
- **用戶狀態**: 未付費或訂閱已過期
- **權限**: 僅有基本功能
- **用戶體驗**: 會看到升級提示

---

## 🗄️ 資料庫欄位說明

### 關鍵欄位

| 欄位名稱 | 說明 | 範例值 |
|---------|------|--------|
| `subscription_plan` | 訂閱方案 | `'pro'` 或 `null` |
| `subscription_status` | 訂閱狀態 | `'active'`, `'inactive'` |
| `current_period_end` | 計費週期結束時間 | `'2025-08-20 10:30:00'` |
| `cancel_at_period_end` | 是否在週期結束時取消 | `true` 或 `false` |

---

## 🔍 三種狀態的判斷規則

### 📊 狀態對應表

| 訂閱狀態 | subscription_plan | subscription_status | cancel_at_period_end | current_period_end | 權限 |
|---------|------------------|-------------------|---------------------|-------------------|------|
| **會續訂** | `'pro'` | `'active'` | `false` | `> 現在時間` | ✅ 完整功能 |
| **會到期** | `'pro'` | `'active'` | `true` | `> 現在時間` | ✅ 完整功能 |
| **免費版** | `null` | `'inactive'` | `false` | `null` | ❌ 基本功能 |

### 🔎 簡易判斷邏輯

#### 1. 訂閱中、會續訂 ✅
```
✓ 是專業版 (subscription_plan = 'pro')
✓ 狀態生效 (subscription_status = 'active')  
✓ 不會取消 (cancel_at_period_end = false)
✓ 還沒到期 (current_period_end > 現在時間)
```

#### 2. 訂閱中、會到期 ⏰
```
✓ 是專業版 (subscription_plan = 'pro')
✓ 狀態生效 (subscription_status = 'active')
✓ 會取消 (cancel_at_period_end = true)
✓ 還沒到期 (current_period_end > 現在時間)
```

#### 3. 免費版 🆓
```
沒有付費方案 (subscription_plan = null)
或 狀態未生效 (subscription_status = 'inactive')
或 已經過期 (current_period_end < 現在時間)
```

---

## 🔄 狀態轉換流程

### 用戶升級流程
```
免費版 → 付費升級 → 訂閱中(會續訂)
```

### 用戶取消訂閱流程  
```
訂閱中(會續訂) → 取消續訂 → 訂閱中(會到期) → 免費版
```

### 用戶重新啟用流程
```
訂閱中(會到期) → 重新啟用 → 訂閱中(會續訂)
```

---

## ⏰ 自動到期處理機制

### 🤖 Polar 自動化流程

當用戶訂閱到期時，系統會自動處理，無需人工干預：

#### 完整流程
```
用戶取消訂閱 → 設定到期標記 → 享受服務至週期結束 → Polar 自動觸發到期事件 → 系統自動降級為免費版
```

#### 處理時機
1. **立即**: 用戶取消時設定 `cancel_at_period_end = true`
2. **持續**: 用戶仍可使用專業版功能直到 `current_period_end`
3. **到期**: Polar 在到期時間自動發送通知
4. **降級**: 系統自動將用戶改為免費版

#### 優勢
- ✅ **完全自動化**: 無需人工監控
- ✅ **用戶友善**: 付費期間持續享受服務
- ✅ **精確控制**: 準確的時間管理
- ✅ **可靠安全**: 自動重試和錯誤處理

---

## 📊 常見問題與解答

### Q1: 為什麼用戶取消訂閱後還能使用專業版？
**A**: 用戶已經付費到當前週期結束，讓他們享受完整的付費期間是合理的。

### Q2: 系統如何知道何時將用戶降級？
**A**: Polar 會在 `current_period_end` 時間到達時自動發送通知，系統接收後自動處理降級。

### Q3: 如果自動處理失敗怎麼辦？
**A**: Polar 有自動重試機制，會持續嘗試直到處理成功。

### Q4: 用戶可以在到期前重新啟用訂閱嗎？
**A**: 可以，只要在 `current_period_end` 之前，用戶都可以重新啟用自動續訂。

---

## 🎯 測試檢查要點

### 基本功能測試
- [ ] 新用戶預設為免費版
- [ ] 升級後狀態正確顯示為「會續訂」
- [ ] 取消後狀態變為「會到期」
- [ ] 重新啟用後變回「會續訂」
- [ ] 到期後自動變為「免費版」

### 權限測試
- [ ] 專業版用戶可以使用所有功能
- [ ] 免費版用戶只能使用基本功能
- [ ] 即將到期用戶仍可使用專業版功能

### 自動化測試
- [ ] 到期時自動降級正常運作
- [ ] 狀態顯示準確反映實際權限
- [ ] 用戶介面提示清楚易懂

---

## 📝 總結

透過 Supabase 的四個關鍵欄位，我們可以準確追蹤和管理用戶的訂閱狀態：

1. **精確控制**: 清楚區分三種訂閱狀態
2. **自動化處理**: Polar 自動處理到期事件
3. **用戶友善**: 取消後仍可享受完整付費期間
4. **業務可靠**: 確保計費準確和服務連續性

這個設計確保了系統的可靠性和用戶體驗的一致性，同時為業務分析提供了清晰的資料基礎。

---

**文檔版本**: 2.0 (簡化版)  
**最後更新**: 2025-07-20  
**維護者**: 開發團隊  
**狀態**: ✅ 已完成