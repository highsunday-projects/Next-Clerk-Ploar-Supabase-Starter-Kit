Index: .idea/workspace.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project version=\"4\">\n  <component name=\"AutoImportSettings\">\n    <option name=\"autoReloadType\" value=\"SELECTIVE\" />\n  </component>\n  <component name=\"ChangeListManager\">\n    <list default=\"true\" id=\"03e93c0d-3325-4b1e-b22c-75672eb5a3a6\" name=\"Changes\" comment=\"\">\n      <change beforePath=\"$PROJECT_DIR$/src/app/api/webhooks/polar/route.ts\" beforeDir=\"false\" afterPath=\"$PROJECT_DIR$/src/app/api/webhooks/polar/route.ts\" afterDir=\"false\" />\n    </list>\n    <option name=\"SHOW_DIALOG\" value=\"false\" />\n    <option name=\"HIGHLIGHT_CONFLICTS\" value=\"true\" />\n    <option name=\"HIGHLIGHT_NON_ACTIVE_CHANGELIST\" value=\"false\" />\n    <option name=\"LAST_RESOLUTION\" value=\"IGNORE\" />\n  </component>\n  <component name=\"Git.Settings\">\n    <option name=\"RECENT_BRANCH_BY_REPOSITORY\">\n      <map>\n        <entry key=\"$PROJECT_DIR$\" value=\"main\" />\n      </map>\n    </option>\n    <option name=\"RECENT_GIT_ROOT_PATH\" value=\"$PROJECT_DIR$\" />\n    <option name=\"RESET_MODE\" value=\"HARD\" />\n  </component>\n  <component name=\"GitRewordedCommitMessages\">\n    <option name=\"commitMessagesMapping\">\n      <RewordedCommitMessageMapping>\n        <option name=\"originalMessage\" value=\"adjust top\" />\n        <option name=\"rewordedMessage\" value=\"SF10 - å‰ç«¯è¨‚é–±ç‹€æ…‹é¡¯ç¤ºç°¡åŒ– (ç°¡åŒ–éœ€æ±‚)\" />\n      </RewordedCommitMessageMapping>\n    </option>\n    <option name=\"currentCommit\" value=\"1\" />\n    <option name=\"onto\" value=\"99c9878a769ec6996fa4c0516d8deed67b53f9e9\" />\n  </component>\n  <component name=\"MarkdownSettingsMigration\">\n    <option name=\"stateVersion\" value=\"1\" />\n  </component>\n  <component name=\"ProjectId\" id=\"2zyx8YSFd5j4dGGD34zhTaIn90X\" />\n  <component name=\"ProjectViewState\">\n    <option name=\"hideEmptyMiddlePackages\" value=\"true\" />\n    <option name=\"showLibraryContents\" value=\"true\" />\n  </component>\n  <component name=\"PropertiesComponent\">{\n  &quot;keyToString&quot;: {\n    &quot;RunOnceActivity.OpenProjectViewOnStart&quot;: &quot;true&quot;,\n    &quot;RunOnceActivity.ShowReadmeOnStart&quot;: &quot;true&quot;,\n    &quot;WebServerToolWindowFactoryState&quot;: &quot;false&quot;,\n    &quot;last_opened_file_path&quot;: &quot;/Users/highsunday/Program/Next-Clerk-Ploar-Supabase Starter Kit/documents/åŠŸèƒ½&quot;,\n    &quot;node.js.detected.package.eslint&quot;: &quot;true&quot;,\n    &quot;node.js.detected.package.tslint&quot;: &quot;true&quot;,\n    &quot;node.js.selected.package.eslint&quot;: &quot;(autodetect)&quot;,\n    &quot;node.js.selected.package.tslint&quot;: &quot;(autodetect)&quot;,\n    &quot;nodejs_package_manager_path&quot;: &quot;npm&quot;,\n    &quot;ts.external.directory.path&quot;: &quot;/Applications/WebStorm.app/Contents/plugins/javascript-impl/jsLanguageServicesImpl/external&quot;,\n    &quot;vue.rearranger.settings.migration&quot;: &quot;true&quot;\n  }\n}</component>\n  <component name=\"RecentsManager\">\n    <key name=\"CopyFile.RECENT_KEYS\">\n      <recent name=\"$PROJECT_DIR$/documents/åŠŸèƒ½\" />\n    </key>\n  </component>\n  <component name=\"SpellCheckerSettings\" RuntimeDictionaries=\"0\" Folders=\"0\" CustomDictionaries=\"0\" DefaultDictionary=\"application-level\" UseSingleDictionary=\"true\" transferred=\"true\" />\n  <component name=\"TaskManager\">\n    <task active=\"true\" id=\"Default\" summary=\"Default task\">\n      <changelist id=\"03e93c0d-3325-4b1e-b22c-75672eb5a3a6\" name=\"Changes\" comment=\"\" />\n      <created>1752716954330</created>\n      <option name=\"number\" value=\"Default\" />\n      <option name=\"presentableId\" value=\"Default\" />\n      <updated>1752716954330</updated>\n      <workItem from=\"1752716957568\" duration=\"4429000\" />\n      <workItem from=\"1752921879652\" duration=\"10490000\" />\n      <workItem from=\"1753073750430\" duration=\"674000\" />\n    </task>\n    <servers />\n  </component>\n  <component name=\"TypeScriptGeneratedFilesManager\">\n    <option name=\"version\" value=\"3\" />\n  </component>\n  <component name=\"Vcs.Log.Tabs.Properties\">\n    <option name=\"TAB_STATES\">\n      <map>\n        <entry key=\"MAIN\">\n          <value>\n            <State />\n          </value>\n        </entry>\n      </map>\n    </option>\n  </component>\n</project>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/.idea/workspace.xml b/.idea/workspace.xml
--- a/.idea/workspace.xml	(revision 2ea00787e0fa981452fefc7654ef4af67c1b6586)
+++ b/.idea/workspace.xml	(date 1753081646783)
@@ -5,7 +5,7 @@
   </component>
   <component name="ChangeListManager">
     <list default="true" id="03e93c0d-3325-4b1e-b22c-75672eb5a3a6" name="Changes" comment="">
-      <change beforePath="$PROJECT_DIR$/src/app/api/webhooks/polar/route.ts" beforeDir="false" afterPath="$PROJECT_DIR$/src/app/api/webhooks/polar/route.ts" afterDir="false" />
+      <change beforePath="$PROJECT_DIR$/documents/åŠŸèƒ½/B01-Polar-Webhook-æ¬„ä½æ˜ å°„éŒ¯èª¤ä¿®æ­£.md" beforeDir="false" afterPath="$PROJECT_DIR$/documents/åŠŸèƒ½/B01-Polar-Webhook-æ¬„ä½æ˜ å°„éŒ¯èª¤ä¿®æ­£.md" afterDir="false" />
     </list>
     <option name="SHOW_DIALOG" value="false" />
     <option name="HIGHLIGHT_CONFLICTS" value="true" />
Index: documents/åŠŸèƒ½/B01-Polar-Webhook-æ¬„ä½æ˜ å°„éŒ¯èª¤ä¿®æ­£.md
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>---\nuuid: b01-polar-webhook-field-mapping-fix\n---\n\n# B01 - Polar Webhook æ¬„ä½æ˜ å°„éŒ¯èª¤ä¿®æ­£\n\n## \uD83D\uDD0D å•é¡Œæ¦‚è¿°\n\n**å•é¡Œæè¿°**: ç•¶ç”¨æˆ¶å–æ¶ˆ Polar è¨‚é–±æ™‚ï¼Œwebhook è§¸ç™¼äº†å¤šå€‹äº‹ä»¶ï¼Œä½† Supabase ç‹€æ…‹æ›´æ–°å‡ºç¾éŒ¯èª¤ï¼Œæœ€çµ‚ç‹€æ…‹èˆ‡é æœŸä¸ç¬¦ã€‚\n\n**å½±éŸ¿ç¯„åœ**: \n- ç”¨æˆ¶å–æ¶ˆè¨‚é–±å¾Œç‹€æ…‹é¡¯ç¤ºéŒ¯èª¤\n- è¨‚é–±ç‹€æ…‹åœ¨å¤šå€‹ webhook äº‹ä»¶é–“ä¸ä¸€è‡´\n- é—œéµè³‡æ–™ï¼ˆcancelAtPeriodEndï¼‰éºå¤±å°è‡´é‚è¼¯åˆ¤æ–·å¤±æ•ˆ\n\n**åš´é‡ç¨‹åº¦**: \uD83D\uDD34 é«˜ - å½±éŸ¿ä»˜è²»ç”¨æˆ¶çš„è¨‚é–±ç‹€æ…‹æ­£ç¢ºæ€§\n\n## \uD83D\uDCCB äº‹ä»¶æ™‚åºåˆ†æ\n\n### è§¸ç™¼çš„ Webhook äº‹ä»¶é †åºï¼š\n1. **subscription.updated** - è¨­å®šå–æ¶ˆæ¨™èªŒ\n2. **subscription.canceled** - è¨‚é–±å–æ¶ˆäº‹ä»¶  \n3. **subscription.updated** - å†æ¬¡æ›´æ–°ï¼ˆé‡è¤‡äº‹ä»¶ï¼‰\n\n## âŒ ç™¼ç¾çš„ä¸»è¦å•é¡Œ\n\n### 1. **ç¼ºå¤±æ•¸æ“šå•é¡Œ**\n```javascript\nProcessing subscription update: {\n  subscriptionId: '1b7d5ed3-41eb-47d7-9184-ceae11a5fee5',\n  userId: 'user_3086xRRBAJLroUYxctPm1iG7kPC',\n  status: 'active',\n  cancelAtPeriodEnd: undefined,  // âŒ é—œéµè³‡æ–™éºå¤±\n  currentPeriodStart: undefined, // âŒ é—œéµè³‡æ–™éºå¤±\n  currentPeriodEnd: undefined    // âŒ é—œéµè³‡æ–™éºå¤±\n}\n```\n\n**åŸå› **: ç¨‹å¼ç¢¼å¾ webhook payload æå–è³‡æ–™æ™‚ï¼Œæ¬„ä½åç¨±ä¸åŒ¹é…\n\n### 2. **è³‡æ–™æå–é‚è¼¯éŒ¯èª¤**\nåœ¨ `route.ts` ä¸­çš„è³‡æ–™æå–ï¼š\n```javascript\n// âŒ éŒ¯èª¤çš„æå–æ–¹å¼\ncancelAtPeriodEnd: subscription.cancel_at_period_end,\ncurrentPeriodStart: subscription.current_period_start,\ncurrentPeriodEnd: subscription.current_period_end\n```\n\n**å¯¦éš› Payload çµæ§‹**:\n```javascript\n// âœ… æ­£ç¢ºçš„æ¬„ä½åç¨± (camelCase)\n{\n  \"cancelAtPeriodEnd\": true,\n  \"currentPeriodStart\": \"2025-07-21T06:47:25.000Z\",\n  \"currentPeriodEnd\": \"2025-08-21T06:47:25.000Z\"\n}\n```\n\n### 3. **ç‹€æ…‹åˆ¤æ–·é‚è¼¯å¤±æ•ˆ**\nå› ç‚º `cancelAtPeriodEnd` ç‚º `undefined`ï¼Œ`mapPolarStatusToLocal` å‡½æ•¸ç„¡æ³•æ­£ç¢ºåˆ¤æ–·ï¼š\n\n```javascript\n// âŒ å› ç‚º cancelAtPeriodEnd = undefinedï¼Œç¸½æ˜¯èµ° else åˆ†æ”¯\nfunction mapPolarStatusToLocal(polarStatus: string, cancelAtPeriodEnd: boolean = false) {\n  switch (polarStatus) {\n    case 'active':\n      return cancelAtPeriodEnd ? 'active_ending' : 'active_recurring'; \n      // çµæœç¸½æ˜¯ 'active_recurring'ï¼Œæ‡‰è©²è¦æ˜¯ 'active_ending'\n  }\n}\n```\n\n### 4. **äº‹ä»¶è™•ç†é †åºå•é¡Œ**\n- **subscription.updated** â†’ ç‹€æ…‹è®Šç‚º `active_recurring` âŒ\n- **subscription.canceled** â†’ ç‹€æ…‹è®Šç‚º `active_ending` âœ…  \n- **subscription.updated** â†’ åˆè®Šå› `active_recurring` âŒ\n\næœ€çµ‚çµæœéŒ¯èª¤ï¼\n\n## \uD83D\uDD27 è§£æ±ºæ–¹æ¡ˆ\n\n### 1. **ä¿®æ­£è³‡æ–™æå–é‚è¼¯**\n```javascript\n// âœ… ä¿®æ­£å¾Œçš„ç¨‹å¼ç¢¼\nconsole.log('Processing subscription update:', {\n  subscriptionId: subscription.id,\n  userId: clerkUserId,\n  status: subscription.status,\n  cancelAtPeriodEnd: subscription.cancelAtPeriodEnd, // ä¿®æ­£æ¬„ä½åç¨±\n  currentPeriodStart: subscription.currentPeriodStart, // ä¿®æ­£æ¬„ä½åç¨±\n  currentPeriodEnd: subscription.currentPeriodEnd // ä¿®æ­£æ¬„ä½åç¨±\n});\n```\n\n### 2. **æ”¹é€²ç‹€æ…‹åˆ¤æ–·é‚è¼¯**\n```javascript\n// âœ… æ›´å®‰å…¨çš„åˆ¤æ–·æ–¹å¼\nfunction mapPolarStatusToLocal(subscription: any): SubscriptionStatus {\n  // ç›´æ¥å¾å®Œæ•´çš„ subscription ç‰©ä»¶åˆ¤æ–·\n  const { status, cancelAtPeriodEnd, canceledAt } = subscription;\n  \n  if (status === 'active') {\n    // æª¢æŸ¥æ˜¯å¦æœ‰å–æ¶ˆæ¨™èªŒæˆ–å–æ¶ˆæ™‚é–“\n    return (cancelAtPeriodEnd === true || canceledAt) ? 'active_ending' : 'active_recurring';\n  }\n  \n  return 'inactive';\n}\n```\n\n### 3. **äº‹ä»¶å»é‡æ©Ÿåˆ¶**\n```javascript\n// âœ… é¿å…é‡è¤‡è™•ç†ç›¸åŒäº‹ä»¶\nconst processedEvents = new Set();\n\nasync function handleSubscriptionUpdated(event: any): Promise<void> {\n  const eventKey = `${event.data.id}-${event.data.modified_at}`;\n  \n  if (processedEvents.has(eventKey)) {\n    console.log('Event already processed, skipping:', eventKey);\n    return;\n  }\n  \n  processedEvents.add(eventKey);\n  // ... è™•ç†é‚è¼¯\n}\n```\n\n### 4. **å„ªå…ˆè™•ç†å–æ¶ˆäº‹ä»¶**\n```javascript\n// âœ… æ ¹æ“šäº‹ä»¶é¡å‹æ±ºå®šè™•ç†å„ªå…ˆç´š\nasync function handleSubscriptionEvent(event: any): Promise<void> {\n  const subscription = event.data;\n  const clerkUserId = subscription.metadata?.clerk_user_id;\n  \n  // å¦‚æœæœ‰å–æ¶ˆæ¨™èªŒï¼Œç›´æ¥è¨­å®šç‚º active_ending\n  if (subscription.cancelAtPeriodEnd === true || subscription.canceledAt) {\n    await updateSubscriptionStatus(clerkUserId, 'active_ending');\n    return;\n  }\n  \n  // å¦å‰‡æŒ‰ä¸€èˆ¬é‚è¼¯è™•ç†\n  const status = mapPolarStatusToLocal(subscription);\n  await updateSubscriptionStatus(clerkUserId, status);\n}\n```\n\n## \uD83C\uDFAF ç«‹å³ä¿®æ­£å»ºè­°\n\n### é«˜å„ªå…ˆç´šä¿®æ­£ï¼š\n1. âœ… **ä¿®æ­£æ¬„ä½åç¨±**: `cancel_at_period_end` â†’ `cancelAtPeriodEnd`\n2. âœ… **ä¿®æ­£å‡½æ•¸èª¿ç”¨**: å‚³å…¥å®Œæ•´ subscription ç‰©ä»¶è€Œéå€‹åˆ¥åƒæ•¸\n3. âœ… **åŠ å…¥äº‹ä»¶å»é‡**: é˜²æ­¢é‡è¤‡è™•ç†\n\n### ä¸­å„ªå…ˆç´šæ”¹é€²ï¼š\n1. \uD83D\uDD04 **åŠ å…¥è©³ç´° logging**: è¨˜éŒ„æ¯æ­¥é©Ÿçš„è³‡æ–™ç‹€æ…‹\n2. \uD83D\uDD04 **éŒ¯èª¤æ¢å¾©æ©Ÿåˆ¶**: ç•¶è³‡æ–™ä¸ä¸€è‡´æ™‚çš„ä¿®å¾©é‚è¼¯\n3. \uD83D\uDD04 **ç›£æ§å‘Šè­¦**: ç•¶ç‹€æ…‹ç•°å¸¸æ™‚ç™¼é€é€šçŸ¥\n\n## \uD83D\uDCA1 é é˜²æªæ–½\n\n1. **å‹åˆ¥æª¢æŸ¥**: ä½¿ç”¨ TypeScript ä»‹é¢å®šç¾© webhook payload\n2. **å–®å…ƒæ¸¬è©¦**: é‡å°ä¸åŒ webhook äº‹ä»¶çµ„åˆé€²è¡Œæ¸¬è©¦  \n3. **æ•´åˆæ¸¬è©¦**: æ¨¡æ“¬å®Œæ•´çš„è¨‚é–±ç”Ÿå‘½é€±æœŸ\n4. **ç›£æ§å„€è¡¨æ¿**: å³æ™‚ç›£æ§è¨‚é–±ç‹€æ…‹è®ŠåŒ–\n\n## \uD83D\uDEA8 ç·Šæ€¥ä¿®æ­£æ­¥é©Ÿ\n\nå¦‚æœç¾åœ¨æœ‰ç”¨æˆ¶è³‡æ–™ä¸æ­£ç¢ºï¼š\n\n```sql\n-- æª¢æŸ¥å•é¡Œç”¨æˆ¶\nSELECT clerk_user_id, subscription_status, subscription_plan, current_period_end, polar_subscription_id\nFROM users \nWHERE polar_subscription_id = '1b7d5ed3-41eb-47d7-9184-ceae11a5fee5';\n\n-- æ‰‹å‹•ä¿®æ­£ï¼ˆç¢ºèª Polar å¾Œå°ç‹€æ…‹å¾ŒåŸ·è¡Œï¼‰\nUPDATE users \nSET subscription_status = 'active_ending'\nWHERE polar_subscription_id = '1b7d5ed3-41eb-47d7-9184-ceae11a5fee5'\nAND subscription_status = 'active_recurring';\n```\n\n## \uD83D\uDCDD ä¿®æ­£ç‹€æ…‹\n\n- [x] ä¿®æ­£æ¬„ä½åç¨±æ˜ å°„\n- [x] æ›´æ–°ç‹€æ…‹åˆ¤æ–·é‚è¼¯\n- [x] å¯¦ä½œäº‹ä»¶å»é‡æ©Ÿåˆ¶\n- [x] åŠ å…¥è©³ç´°æ—¥èªŒè¨˜éŒ„\n- [ ] æ¸¬è©¦ä¿®æ­£çµæœ\n\n## \uD83D\uDD27 å·²å®Œæˆçš„ä¿®æ­£\n\n### 1. **æ¬„ä½åç¨±æ˜ å°„ä¿®æ­£** âœ…\n- ä¿®æ­£ `subscription.cancel_at_period_end` â†’ `subscription.cancelAtPeriodEnd`\n- ä¿®æ­£ `subscription.current_period_start` â†’ `subscription.currentPeriodStart`\n- ä¿®æ­£ `subscription.current_period_end` â†’ `subscription.currentPeriodEnd`\n\n### 2. **ç‹€æ…‹åˆ¤æ–·é‚è¼¯æ”¹é€²** âœ…\n- åœ¨ `mapPolarStatusToLocal` å‡½æ•¸ä¸­åŠ å…¥è©³ç´°æ—¥èªŒè¨˜éŒ„\n- åœ¨ `handleSubscriptionUpdated` ä¸­åŠ å…¥æ™ºèƒ½ç‹€æ…‹åˆ¤æ–·ï¼š\n  - å„ªå…ˆæª¢æŸ¥å–æ¶ˆæ¨™èªŒ (`cancelAtPeriodEnd` æˆ– `canceledAt`)\n  - æœ‰å–æ¶ˆæ¨™èªŒçš„æ´»èºè¨‚é–±ç›´æ¥è¨­ç‚º `active_ending`\n  - é¿å…ç‹€æ…‹åœ¨å¤šå€‹äº‹ä»¶é–“ä¾†å›åˆ‡æ›\n\n### 3. **äº‹ä»¶å»é‡æ©Ÿåˆ¶** âœ…\n- å¯¦ä½œ `processedEvents` Set ä¾†è¿½è¹¤å·²è™•ç†çš„äº‹ä»¶\n- ä½¿ç”¨ `eventKey` æ ¼å¼ï¼š`{eventType}-{subscriptionId}-{modifiedAt}`\n- åœ¨ `handleSubscriptionUpdated` å’Œ `handleSubscriptionCanceled` ä¸­éƒ½åŠ å…¥å»é‡æª¢æŸ¥\n- æ¯å°æ™‚è‡ªå‹•æ¸…ç†éæœŸçš„äº‹ä»¶è¨˜éŒ„\n\n### 4. **è©³ç´°æ—¥èªŒè¨˜éŒ„** âœ…\n- åœ¨ç‹€æ…‹æ˜ å°„å‡½æ•¸ä¸­åŠ å…¥è©³ç´°çš„ console.log\n- åœ¨äº‹ä»¶è™•ç†å‡½æ•¸ä¸­è¨˜éŒ„è™•ç†é‚è¼¯çš„æ±ºç­–éç¨‹\n- è¨˜éŒ„äº‹ä»¶å»é‡çš„æƒ…æ³\n\n---\n\n**å»ºç«‹æ—¥æœŸ**: 2025-07-21  \n**è² è²¬äºº**: é–‹ç™¼åœ˜éšŠ  \n**é è¨ˆå®Œæˆ**: 2025-07-21  \n**å„ªå…ˆç´š**: é«˜\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/documents/åŠŸèƒ½/B01-Polar-Webhook-æ¬„ä½æ˜ å°„éŒ¯èª¤ä¿®æ­£.md b/documents/åŠŸèƒ½/B01-Polar-Webhook-æ¬„ä½æ˜ å°„éŒ¯èª¤ä¿®æ­£.md
--- a/documents/åŠŸèƒ½/B01-Polar-Webhook-æ¬„ä½æ˜ å°„éŒ¯èª¤ä¿®æ­£.md	(revision 2ea00787e0fa981452fefc7654ef4af67c1b6586)
+++ b/documents/åŠŸèƒ½/B01-Polar-Webhook-æ¬„ä½æ˜ å°„éŒ¯èª¤ä¿®æ­£.md	(date 1753081536052)
@@ -215,6 +215,42 @@
 - åœ¨äº‹ä»¶è™•ç†å‡½æ•¸ä¸­è¨˜éŒ„è™•ç†é‚è¼¯çš„æ±ºç­–éç¨‹
 - è¨˜éŒ„äº‹ä»¶å»é‡çš„æƒ…æ³
 
+## ğŸ§ª æ¸¬è©¦å»ºè­°
+
+### æ¸¬è©¦å ´æ™¯ 1: ç”¨æˆ¶å–æ¶ˆè¨‚é–±
+1. åœ¨ Polar å¾Œå°å–æ¶ˆä¸€å€‹æ´»èºè¨‚é–±
+2. è§€å¯Ÿ webhook æ—¥èªŒï¼Œæ‡‰è©²çœ‹åˆ°ï¼š
+   ```
+   Processing subscription update: {
+     subscriptionId: "xxx",
+     cancelAtPeriodEnd: true,  // âœ… ä¸å†æ˜¯ undefined
+     currentPeriodEnd: "2025-08-21T06:47:25.000Z"  // âœ… ä¸å†æ˜¯ undefined
+   }
+   Subscription marked for cancellation for user xxx - set to active_ending
+   ```
+3. æª¢æŸ¥è³‡æ–™åº«ï¼Œç”¨æˆ¶ç‹€æ…‹æ‡‰ç‚º `active_ending`
+
+### æ¸¬è©¦å ´æ™¯ 2: é‡è¤‡äº‹ä»¶è™•ç†
+1. æ‰‹å‹•è§¸ç™¼ç›¸åŒçš„ webhook äº‹ä»¶
+2. ç¬¬äºŒæ¬¡æ‡‰è©²çœ‹åˆ°ï¼š
+   ```
+   Event already processed, skipping: updated-xxx-timestamp
+   ```
+
+### æ¸¬è©¦å ´æ™¯ 3: ç‹€æ…‹æ˜ å°„
+1. æ¸¬è©¦ä¸åŒçš„ Polar ç‹€æ…‹å€¼
+2. æª¢æŸ¥ `mapPolarStatusToLocal` çš„æ—¥èªŒè¼¸å‡ºï¼š
+   ```
+   Mapping Polar status: { polarStatus: "active", cancelAtPeriodEnd: true }
+   Active status mapped to: active_ending
+   ```
+
+### é©—è­‰æ¸…å–®
+- [ ] å–æ¶ˆè¨‚é–±å¾Œç‹€æ…‹æ­£ç¢ºé¡¯ç¤ºç‚º `active_ending`
+- [ ] é‡è¤‡äº‹ä»¶è¢«æ­£ç¢ºéæ¿¾
+- [ ] æ—¥èªŒè¨˜éŒ„å®Œæ•´ä¸”æ¸…æ™°
+- [ ] è³‡æ–™åº«ç‹€æ…‹èˆ‡ Polar å¾Œå°ä¸€è‡´
+
 ---
 
 **å»ºç«‹æ—¥æœŸ**: 2025-07-21  
