---
title: Dashboard 設定頁面整合 Clerk 密碼管理功能
author: 開發團隊
date: 2025-07-17
version: 1.0
uuid: 7e632d602493469cb84dfd645da84e1a
---

# SF03 - Clerk 密碼管理功能 (簡化需求)

## 1. 功能概述 (Feature Overview)

本功能旨在為已整合 Clerk 認證系統的用戶儀表板新增密碼管理功能，讓用戶可以在個人資料頁面中安全地管理自己的登入密碼。這將完善用戶的帳戶自主管理能力，提升整體用戶體驗和帳戶安全性。特別針對多種登入方式（Google OAuth + 密碼登入）的用戶，提供統一的密碼管理介面。

## 2. 需求描述 (Requirement/User Story)

- **As a** 已登入的平台用戶
- **I want** 能夠在儀表板的個人資料頁面中變更或設置我的登入密碼
- **So that** 我可以確保帳戶安全，並且能夠使用密碼作為備用登入方式

## 3. 功能要求 (Functional Requirements)

### 基本要求：
- **要求 1**：在現有的 `/dashboard/profile` 頁面中新增「密碼管理」區塊
- **要求 2**：支援兩種密碼操作情境：
  - 已有密碼用戶：變更現有密碼（需要輸入目前密碼）
  - 無密碼用戶（純 Google 登入）：設置新密碼（不需目前密碼）
- **要求 3**：提供密碼強度驗證和確認密碼功能
- **要求 4**：顯示用戶目前的登入方式狀態（Google + 密碼 / 僅 Google / 僅密碼）
- **要求 5**：整合 Clerk 的 `user.updatePassword()` API 進行密碼操作
- **要求 6**：提供操作成功/失敗的使用者回饋

### 例外處理：
- **情況 1**：密碼不符合安全要求時，顯示清楚的錯誤訊息和改善建議
- **情況 2**：新密碼與確認密碼不一致時，阻止提交並提示用戶
- **情況 3**：網路錯誤或 API 失敗時，提供友善的錯誤處理和重試機制
- **情況 4**：已有密碼的用戶輸入錯誤的目前密碼時，顯示驗證失敗訊息

## 4. 驗收標準 (Acceptance Criteria)

- [x] **密碼管理介面**：個人資料頁面正確顯示密碼管理區塊，包含適當的表單欄位
- [x] **動態表單顯示**：根據用戶狀態（有無密碼）動態顯示不同的表單欄位
- [x] **密碼操作功能**：用戶可以成功設置新密碼或變更現有密碼
- [x] **驗證機制**：密碼強度檢查、確認密碼驗證、目前密碼驗證正常運作
- [x] **使用者回饋**：操作成功時顯示確認訊息，失敗時顯示具體錯誤原因
- [x] **登入方式顯示**：正確顯示用戶目前可用的登入方式

## 5. 實作註記 (Implementation Notes)

### 技術規格：
- **前端框架**：React + TypeScript + Tailwind CSS
- **認證服務**：Clerk SDK (@clerk/nextjs)
- **表單管理**：React useState hooks
- **頁面位置**：`src/app/dashboard/profile/page.tsx` 或 `src/app/dashboard/profile/[[...rest]]/page.tsx`

### 核心 API 介面：
- **Clerk API**：`user.updatePassword()`
  - 參數（有密碼用戶）：`{ currentPassword: string, newPassword: string }`
  - 參數（無密碼用戶）：`{ newPassword: string }`
  - 回應：Promise<void> 或錯誤例外

### 狀態檢查方法：
- **密碼狀態**：`user?.passwordEnabled`
- **外部帳戶**：`user?.externalAccounts`
- **Google 帳戶**：檢查 provider === "google"

### 組件架構：
```
PasswordManager 組件
├── 用戶狀態分析 (hasPassword, hasGoogleAccount)
├── 動態表單渲染
│   ├── 目前密碼欄位 (僅有密碼用戶)
│   ├── 新密碼欄位
│   └── 確認密碼欄位
├── 密碼驗證邏輯
└── API 呼叫處理
```

### 外部相依性：
- Clerk 認證服務正常運作
- 用戶已完成登入驗證
- 個人資料頁面的現有佈局和樣式系統

## 6. 非功能性需求 (Non-Functional Requirements)

- **效能要求**：密碼更新操作回應時間 < 3 秒，介面無明顯延遲
- **安全性要求**：
  - 密碼最小長度 8 字元，包含英數混合
  - 目前密碼驗證透過 Clerk 安全 API
  - 表單提交時顯示載入狀態，防止重複提交
- **可用性要求**：
  - 清楚的操作指引和狀態說明
  - 即時的表單驗證回饋
  - 響應式設計，支援手機和桌面裝置
- **維護性要求**：
  - 可重用的密碼管理組件
  - 清楚的註解和類型定義
  - 遵循專案現有的程式碼風格

## 7. 補充說明 (Additional Notes)

### 設計考量：
- 密碼管理區塊應整合到現有的個人資料頁面中，作為用戶資訊的一部分
- 介面設計要與現有的儀表板風格保持一致
- 考慮用戶可能同時擁有多種登入方式的情境
- 可考慮與 Clerk 內建的 UserProfile 組件並列或整合顯示

### 使用者體驗優化：
- 提供密碼強度指示器（可選，未來擴展）
- 在設置密碼成功後，提醒用戶現在可以使用信箱密碼登入
- 為純 Google 用戶提供設置密碼的動機說明（備用登入方式）

### 未來擴展可能：
- 整合密碼歷史檢查（防止重複使用舊密碼）
- 支援密碼強度視覺化指標
- 整合二次驗證設定
- 登入裝置管理

---

## 開發提醒 (Development Notes)

**前置條件**：
- SF02 Clerk 認證系統整合已完成
- 用戶儀表板和個人資料頁面已建立
- Clerk SDK 正確配置並可正常使用

**開發流程建議**：
1. **第一步**：分析現有個人資料頁面結構，規劃密碼管理區塊的位置
2. **第二步**：建立 PasswordManager 組件，實現狀態檢查邏輯
3. **第三步**：實作動態表單渲染和基本驗證
4. **第四步**：整合 Clerk API，處理密碼更新邏輯
5. **第五步**：新增錯誤處理和使用者回饋機制
6. **第六步**：測試各種用戶狀態和邊界情況
7. **第七步**：優化使用者介面和體驗

**測試重點**：
- 不同用戶狀態的表單顯示正確性
- 密碼驗證規則的有效性
- API 成功和失敗情況的處理
- 各種錯誤情境的使用者體驗

**風險評估**：
- **低風險**：功能相對簡單，主要使用 Clerk 現有 API
- **注意事項**：確保密碼安全性要求符合 Clerk 的規範
- **回退方案**：如遇問題，用戶仍可使用 Clerk 內建的 UserProfile 組件

**完成指標**：
- 所有驗收標準通過測試
- 程式碼通過 ESLint 檢查
- 在不同瀏覽器和裝置上正常運作
- 與現有儀表板設計風格一致

---

## 實作完成記錄 (Implementation Completion)

**完成日期**: 2025-07-16
**實作狀態**: ✅ 已完成

### 已實作的功能模組

#### 密碼管理組件 (`src/components/profile/PasswordManager.tsx`)
- ✅ **用戶狀態檢測**: 自動識別有密碼/無密碼用戶
- ✅ **動態表單渲染**: 根據用戶狀態顯示適當欄位
- ✅ **即時密碼驗證**: 密碼強度檢查和匹配度驗證
- ✅ **安全 API 整合**: 正確調用 Clerk updatePassword API
- ✅ **完整錯誤處理**: 友善的錯誤訊息和狀態管理
- ✅ **登入方式顯示**: 清楚展示目前可用的登入方式

#### 個人資料頁面整合 (`src/app/dashboard/profile/[[...rest]]/page.tsx`)
- ✅ **無縫整合**: 密碼管理組件完美融入現有頁面
- ✅ **一致設計**: 符合整體儀表板的視覺風格
- ✅ **響應式佈局**: 支援桌面和手機裝置

### 技術實作亮點

#### 智能狀態檢測
```typescript
const hasPassword = user?.passwordEnabled || false;
const hasGoogleAccount = user?.externalAccounts?.some(
  account => account.provider === 'google'
) || false;
```

#### 動態 API 調用
- **有密碼用戶**: 需要提供 currentPassword
- **無密碼用戶**: 直接設置 newPassword
- **錯誤處理**: 完整的 TypeScript 類型安全

#### 即時驗證系統
- **密碼強度**: 8字元、包含字母和數字
- **匹配檢查**: 新密碼與確認密碼一致性
- **視覺回饋**: 綠色/紅色圖示即時指示

### 用戶體驗優化
- ✅ **密碼可見性切換**: 眼睛圖示控制密碼顯示
- ✅ **載入狀態**: 提交時的載入動畫和禁用狀態
- ✅ **成功回饋**: 操作完成後的確認訊息
- ✅ **表單重置**: 成功後自動清空敏感資料

### 安全性措施
- ✅ **客戶端驗證**: 減少無效 API 調用
- ✅ **伺服器端驗證**: Clerk 提供的安全保障
- ✅ **錯誤資訊保護**: 不洩露敏感系統資訊

### 程式碼品質
- ✅ **TypeScript 類型安全**: 完整的類型定義
- ✅ **ESLint 檢查通過**: 無程式碼品質問題
- ✅ **React 最佳實踐**: 正確的 Hook 使用和狀態管理
- ✅ **可維護性**: 清晰的組件結構和註解

### 文檔完成
- ✅ **密碼管理說明.md**: 詳細的功能說明和使用指南
- ✅ **Clerk整合說明文件.md**: 更新密碼管理相關內容
- ✅ **故障排除指南**: 常見問題和解決方案

**開發者**: AI Assistant
**測試狀態**: 已通過功能測試和程式碼檢查
**部署狀態**: 可立即部署使用