---
title: Clerk 認證系統整合實作
author: 開發團隊
date: 2025-07-16
version: 1.0
uuid: f4e8d9c2b3a14567890abcdef1234567
---

# SF02 - Clerk 認證系統整合 (簡化需求)

## 1. 功能概述 (Feature Overview)

本功能旨在將 Clerk 認證服務整合到 Next-Clerk-Polar-Supabase Starter Kit 中，提供完整的用戶認證、註冊、登入、登出和個人資料管理功能。這將把現有的靜態登陸頁面升級為具備真實用戶管理功能的 SaaS 應用程式。

## 2. 需求描述 (Requirement/User Story)

- **As a** 潛在用戶
- **I want** 能夠註冊帳號、登入系統並管理我的個人資料
- **So that** 我可以存取受保護的功能和個人化的服務內容

## 3. 功能要求 (Functional Requirements)

### 階段一：基礎設定
- **要求 1**：安裝並配置 Clerk SDK，設定環境變數
- **要求 2**：整合 ClerkProvider 到 Next.js 應用程式中
- **要求 3**：設定 Clerk 中間件進行路由保護

### 階段二：認證頁面
- **要求 4**：建立 `/sign-in` 登入頁面，使用 Clerk 預建組件
- **要求 5**：建立 `/sign-up` 註冊頁面，使用 Clerk 預建組件
- **要求 6**：設定認證完成後的重定向路徑

### 階段三：導航整合
- **要求 7**：更新 Header 組件，顯示登入狀態
- **要求 8**：為已登入用戶顯示用戶頭像和登出按鈕
- **要求 9**：為未登入用戶顯示登入/註冊按鈕

### 階段四：用戶儀表板
- **要求 10**：建立受保護的 `/dashboard` 頁面
- **要求 11**：在儀表板顯示用戶基本資訊
- **要求 12**：提供用戶個人資料編輯功能

### 例外處理：
- **情況 1**：未登入用戶訪問受保護頁面時自動重定向到登入頁面
- **情況 2**：已登入用戶訪問登入/註冊頁面時重定向到儀表板

## 4. 驗收標準 (Acceptance Criteria)

- [x] **環境設定**：Clerk 正確安裝並配置，環境變數設定完成
- [x] **認證流程**：用戶可以成功註冊、登入、登出
- [x] **路由保護**：未登入用戶無法訪問受保護頁面
- [x] **導航更新**：Header 正確顯示登入狀態和相應按鈕
- [x] **儀表板功能**：已登入用戶可以查看和編輯個人資料
- [x] **用戶體驗**：整個認證流程順暢，無明顯錯誤或延遲

## 5. 實作註記 (Implementation Notes)

### 技術規格：
- **Clerk 版本**：`@clerk/nextjs` 最新穩定版
- **認證方式**：電子郵件/密碼（初期）
- **會話管理**：使用 Clerk 內建會話管理
- **安全性**：啟用 Clerk 預設安全設定

### 檔案結構規劃：
```
src/
├── app/
│   ├── sign-in/
│   │   └── [[...sign-in]]/
│   │       └── page.tsx           # 登入頁面
│   ├── sign-up/
│   │   └── [[...sign-up]]/
│   │       └── page.tsx           # 註冊頁面
│   ├── dashboard/
│   │   ├── layout.tsx             # 儀表板佈局
│   │   ├── page.tsx               # 儀表板首頁
│   │   └── profile/
│   │       └── page.tsx           # 個人資料頁面
│   ├── middleware.ts              # Clerk 中間件
│   └── layout.tsx                 # 更新根佈局
├── components/
│   ├── Header.tsx                 # 更新導航欄
│   └── dashboard/
│       ├── UserProfile.tsx        # 用戶資料組件
│       └── DashboardNav.tsx       # 儀表板導航
└── lib/
    └── auth.ts                    # 認證相關工具函數
```

### 環境變數：
```env
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/dashboard
```

## 6. 非功能性需求 (Non-Functional Requirements)

- **安全性要求**：使用 HTTPS，啟用 Clerk 安全標頭，密碼符合安全標準
- **效能要求**：認證流程回應時間 < 2 秒，頁面載入時間 < 3 秒
- **可用性要求**：認證表單易於使用，錯誤訊息清晰明確
- **擴展性要求**：支援未來添加社交登入和多因素認證

## 7. 補充說明 (Additional Notes)

### 開發順序建議：
1. **第一天**：環境設定和基礎配置
2. **第二天**：建立登入/註冊頁面
3. **第三天**：更新導航和路由保護
4. **第四天**：建立用戶儀表板
5. **第五天**：測試和優化

### Clerk 功能選擇：
- **核心功能**：電子郵件註冊、密碼登入、用戶資料管理
- **進階功能**（後期）：社交登入、多因素認證、組織管理
- **自訂選項**：品牌化認證頁面、自訂欄位

### 注意事項：
- Clerk 免費方案支援最多 10,000 月活躍用戶
- 開發期間使用測試環境，正式發布前切換到生產環境
- 保持 Clerk 儀表板和程式碼設定同步

### 測試策略：
- **單元測試**：認證狀態檢查函數
- **整合測試**：完整的註冊/登入流程
- **用戶測試**：不同裝置和瀏覽器的認證體驗

---

## 開發提醒 (Development Notes)

**前置條件**：
- 已完成 SF01 登陸首頁
- Node.js 18+ 開發環境
- Clerk 帳號和專案設定

**開發流程建議**：
1. 先在 Clerk 儀表板完成基本設定
2. 在本地環境測試認證流程
3. 確保所有路由保護正確運作
4. 優化用戶體驗和錯誤處理
5. 進行跨瀏覽器和裝置測試

**常見問題**：
- 環境變數設定錯誤：檢查金鑰是否正確
- 路由重定向問題：確認 URL 設定一致
- 樣式衝突：調整 Clerk 組件的 CSS

**後續整合準備**：
- 用戶資料將為 Supabase 整合做準備
- 認證狀態將影響 Polar 付費功能的存取權限

---

## 實作完成記錄 (Implementation Completion)

**完成日期**: 2025-07-16
**實作狀態**: ✅ 已完成

### 已實作的功能模組

#### 階段一：Clerk 基礎設定
- ✅ **SDK 安裝**: 安裝 @clerk/nextjs 最新版本
- ✅ **環境變數**: 設定完整的 Clerk 環境變數配置
- ✅ **ClerkProvider**: 整合到根佈局，提供全域認證狀態
- ✅ **中間件**: 實現路由保護和自動重定向

#### 階段二：認證頁面
- ✅ **登入頁面**: `/sign-in/[[...sign-in]]/page.tsx` 使用 Clerk 預建組件
- ✅ **註冊頁面**: `/sign-up/[[...sign-up]]/page.tsx` 使用 Clerk 預建組件
- ✅ **樣式自訂**: 整合 Tailwind CSS 樣式，符合品牌設計
- ✅ **重定向設定**: 認證完成後自動導向儀表板

#### 階段三：導航整合
- ✅ **Header 更新**: 整合 Clerk 認證狀態顯示
- ✅ **條件渲染**: 根據登入狀態顯示不同按鈕
- ✅ **UserButton**: 整合用戶頭像和快速操作選單
- ✅ **響應式設計**: 支援桌面和手機版本的認證介面

#### 階段四：用戶儀表板
- ✅ **儀表板佈局**: `/dashboard/layout.tsx` 專用佈局
- ✅ **儀表板首頁**: 用戶總覽、統計數據、快速操作
- ✅ **個人資料頁面**: 使用 Clerk UserProfile 組件
- ✅ **設定頁面**: 通知、安全、介面設定選項
- ✅ **導航系統**: DashboardNav 組件，支援多頁面導航

### 技術實作細節

#### 檔案結構
```
src/
├── app/
│   ├── sign-in/[[...sign-in]]/page.tsx     # 登入頁面
│   ├── sign-up/[[...sign-up]]/page.tsx     # 註冊頁面
│   ├── dashboard/                           # 儀表板區域
│   │   ├── layout.tsx                       # 儀表板佈局
│   │   ├── page.tsx                         # 儀表板首頁
│   │   ├── profile/page.tsx                 # 個人資料
│   │   └── settings/page.tsx                # 設定頁面
│   ├── layout.tsx                           # 根佈局（含 ClerkProvider）
│   └── middleware.ts                        # 路由保護中間件
├── components/
│   ├── Header.tsx                           # 更新的導航欄
│   └── dashboard/
│       └── DashboardNav.tsx                 # 儀表板導航
└── documents/
    └── Clerk整合說明文件.md                 # 完整說明文件
```

#### 安全性實作
- ✅ **路由保護**: 使用 Clerk 中間件保護 `/dashboard` 路由
- ✅ **會話管理**: 利用 Clerk 內建會話管理
- ✅ **環境變數**: 安全的金鑰管理和配置
- ✅ **重定向邏輯**: 防止未授權訪問

#### 用戶體驗優化
- ✅ **無縫整合**: 與現有 SaaS 登陸頁面完美整合
- ✅ **響應式設計**: 支援所有裝置尺寸
- ✅ **載入狀態**: 適當的載入和錯誤處理
- ✅ **視覺一致性**: 統一的設計語言和品牌風格

### 程式碼品質
- ✅ **TypeScript**: 完整的類型安全
- ✅ **ESLint**: 通過所有程式碼品質檢查
- ✅ **組件化**: 可重用的 React 組件架構
- ✅ **最佳實踐**: 遵循 Next.js 和 Clerk 官方建議

### 測試驗證
- ✅ **功能測試**: 註冊、登入、登出流程正常
- ✅ **路由測試**: 保護路由和重定向正確運作
- ✅ **介面測試**: 所有認證介面正常顯示
- ✅ **響應式測試**: 在不同裝置上正常運作

### 文檔完成
- ✅ **整合說明**: 建立詳細的 Clerk 整合說明文件
- ✅ **設定指南**: 包含完整的環境設定步驟
- ✅ **故障排除**: 常見問題和解決方案
- ✅ **最佳實踐**: 安全性和效能優化建議

**開發者**: AI Assistant
**測試狀態**: 已通過完整功能測試
**部署狀態**: 可部署至生產環境（需設定 Clerk 生產金鑰）